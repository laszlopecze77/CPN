#' Maximum Likelihood Estimation for CPN Regression
#'
#' Estimates parameters for a Compound Poisson-Normal (CPN) regression model using
#' maximum likelihood via the Nelder-Mead optimization method.
#'
#' @param X Numeric matrix of predictors (design matrix), with rows corresponding to observations.
#' @param y Numeric vector of observed response values.
#'
#' @return A numeric vector containing the estimated parameters:
#'   \itemize{
#'     \item \code{beta_hat}: Estimated regression coefficients for \code{lambda}
#'     \item \code{mu_hat}: Estimated mean of the normal components
#'     \item \code{sigma_hat}: Estimated standard deviation of the normal components
#'   }
#'
#' @details
#' The model assumes that each response value follows a Compound Poisson-Normal distribution,
#' where the Poisson intensity is modeled via a log-link regression on \code{X}.
#' Initial values for \code{mu} and \code{sigma} are based on non-zero observations in \code{y}.
#'
#' @seealso \code{\link{cpn}}, \code{\link{cpn_regression_neg_log_likelihood}}
#'
#' @examples
#' X <- matrix(rnorm(100), ncol = 2)
#' y <- rpois(50, lambda = exp(X %*% c(0.2, -0.1))) * 3 + rnorm(50)
#' cpn_reg_mle(X, y)
#'
#' @export

cpn_reg_mle <- function(X, y) {
  n <- length(y)
  p <- ncol(X)

  init_beta <- rep(0, p)
  init_mu <- mean(y[y > 0])
  init_sigma <- stats::sd(y[y > 0])

  init_vals <- c(init_beta, init_mu, init_sigma)

  mle_result <- stats::optim(
    par = init_vals,
    fn = cpn_regression_neg_log_likelihood,
    X = X,
    y = y,
    method = "Nelder-Mead",
    control = list(maxit = 1000)
  )

  return(mle_result$par)
}
