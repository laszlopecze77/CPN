---
title: "Compound Poisson-Normal Regression"
author: "Laszlo Pecze"
date: "`r Sys.Date()`"
bibliography: references.bib
nocite: |
  @Nascimento2019, @hu2024, @raqab2021
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Compound Poisson-Normal Regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#"
)
```




# Introduction

In many applied settings—including insurance claims, biological systems, and environmental monitoring—the observed data arise from a random number of additive events, where each event contributes a continuous value. A natural model for such data is the **Compound Poisson-Normal (CPN)** distribution.

The CPN model assumes that the number of events follows a Poisson distribution, and that each event contributes an independent and identically distributed (i.i.d.) **normally distributed** amount.

Formally, let:

- \( N \sim \text{Poisson}(\lambda) \) denote the number of events,
- \( X_1, X_2, \ldots, X_N \overset{\text{i.i.d.}}{\sim} \mathcal{N}(\mu, \sigma^2) \), independent of \( N \),

Then the total observed outcome is modeled as a **compound sum**:

\[
Y = \sum_{i=1}^{N} X_i
\]

The resulting distribution of \( Y \) is known as the **Compound Poisson-Normal distribution**.


The first two moments of the CPN distribution are:

\[
\mathbb{E}[Y] = \lambda \mu,\quad \text{Var}(Y) = \lambda (\mu^2 + \sigma^2)
\]

These follow from the properties of the compound distribution, combining Poisson and Gaussian contributions.
The (approximate) probability density function (pdf) of \( Y \) is:

\[
f_Y(y; \lambda, \mu, \sigma) =
\begin{cases}
e^{-\lambda}, & \text{if } y = 0 \\\\
\sum_{k=1}^{K_{\text{max}}} \frac{e^{-\lambda} \lambda^k}{k!} \cdot \frac{1}{\sqrt{2\pi k \sigma^2}} \exp\left( -\frac{(y - k\mu)^2}{2k\sigma^2} \right), & \text{if } y \neq 0
\end{cases}
\]

**Where:**

- \( y \): the observed total from the compound process  
- \( \lambda \): expected number of Poisson events  
- \( \mu \): mean of each normal component  
- \( \sigma \): standard deviation of each normal component  
- \( k \): number of events (from 1 to \( K_{\text{max}} \))  
- \( K_{\text{max}} \): maximum number of events used in the approximation  

When \( k = 0 \), the sum is defined as a point mass at zero, and its probability is:

\[
P(Y = 0) = P(N = 0) = e^{-\lambda}
\]

In theory, the compound distribution sums over an infinite range of possible Poisson event counts. In practice, this sum must be **truncated** at a finite maximum value \( N_{\max} \), chosen so that the remaining tail probability is negligible.


# Package Setup

To use the function, load the package:

```{r}
library(CPN)
```

# Simulating Data

```{r simu, message=FALSE, warning=FALSE}
set.seed(123)

simulate_cpn_data <- function(n = 200,
                              beta = c(0.5, -0.3, 0.7),
                              mu = 2,
                              sigma = 1) {
  x1 <- factor(sample(c("A", "B"), size = n, replace = TRUE))  # Categorical
  x2 <- rnorm(n)  # Continuous
  X <- model.matrix(~ x1 + x2) # nolint
  eta <- X %*% beta
  lambda <- exp(eta)
  y <- numeric(n)
  for (i in 1:n) {
    k <- rpois(1, lambda[i])
    if (k > 0) {
      y[i] <- sum(rnorm(k, mean = mu, sd = sigma))
    }
  }
  data.frame(y = y, x1 = x1, x2 = x2)
}

data <- simulate_cpn_data()
head(data)
```

# Plot the simulated data

```{r simuplot, message=FALSE, warning=FALSE}
# Scatter plot of y vs x2, colored by x1
colors <- c("A" = "blue", "B" = "red")
plot(
  data$x2, data$y,
  col = colors[data$x1],
  pch = 19, xlab = "x2", ylab = "y",
  main = "Scatter Plot of y vs x2 \n (colored by x1)"
)
legend("topright", legend = levels(data$x1), col = colors, pch = 19)
```

# Fit the CPN Model

```{r}
fit <- cpn(y ~ x1 + x2, data = data)
```

# Summary of Results

```{r}
summary(fit)
```

# Extracting Model Components

```{r}
fit$coefficients
fit$mu
fit$sigma
fit$fitted_values[1:10]  # preview only
```

# Coefficients and Interpretation

```{r coef}
coef(fit)
coef(fit, full = FALSE)  # Includes only linear predictors
```

# Diagnostics and Residuals

```{r diagnostics}
plot(fit)
residuals(fit)[1:10]
```

# Likelihood and Information Criteria

```{r fitstats}
logLik(fit)
AIC(fit)
vcov(fit)
```

# Model Update and Comparison

```{r update-anova}
fit2 <- update(fit, . ~ . - x2)

anova(fit, fit2)  # Likelihood ratio test
anova(fit)        # Model summary
```


# Prediction

```{r predict}
# Original data
predict(fit, type = "response")[1:5]
predict(fit, type = "response", interval = "confidence")[1:5, ]

# New data
new_df <- data.frame(x1 = c("A", "A", "B", "B"), x2 = c(-0.5, -0.2, -0.3, -0.3))
predict(fit, newdata = new_df, type = "response", interval = "confidence")        
```

# Conclusion

The `CPN` package enables effective modeling of semicontinuous data using the
Compound Poisson-Normal model. It supports flexible model specification, S3
methods for diagnostics and inference, and prediction on new data. For more
advanced use, refer to the function documentation or the package reference
manual.

# References
