---
title: "Compound Poisson-Normal Regression"
author: "Laszlo Pecze"
date: "`r Sys.Date()`"
bibliography: references.bib
nocite: |
  @Nascimento2019, @mullahy1986
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Compound Poisson-Normal Regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#"
)
```

# Introduction

This vignette demonstrates how to use the `cpn` function to fit a Compound
Poisson-Normal (CPN) regression model. The model is designed for data with a
mixture of zeros and continuous values, modeled via a compound Poisson
distribution with a Normal component.

# Package Setup

To use the function, load the package:

```{r}
library(CPN)  # Replace with your actual package name
```

# Simulating Data

```{r simu, message=FALSE, warning=FALSE}
set.seed(123)

simulate_cpn_data <- function(n = 200,
                              beta = c(0.5, -0.3, 0.7),
                              mu = 2,
                              sigma = 1) {
  x1 <- factor(sample(c("A", "B"), size = n, replace = TRUE))  # Categorical
  x2 <- rnorm(n)  # Continuous
  X <- model.matrix(~ x1 + x2) # nolint
  eta <- X %*% beta
  lambda <- exp(eta)
  y <- numeric(n)
  for (i in 1:n) {
    k <- rpois(1, lambda[i])
    if (k > 0) {
      y[i] <- sum(rnorm(k, mean = mu, sd = sigma))
    }
  }
  data.frame(y = y, x1 = x1, x2 = x2)
}

data <- simulate_cpn_data()
head(data)
```

# Plot the simulated data

```{r simuplot, message=FALSE, warning=FALSE}
# Scatter plot of y vs x2, colored by x1
colors <- c("A" = "blue", "B" = "red")
plot(
  data$x2, data$y,
  col = colors[data$x1],
  pch = 19, xlab = "x2", ylab = "y",
  main = "Scatter Plot of y vs x2 \n (colored by x1)"
)
legend("topright", legend = levels(data$x1), col = colors, pch = 19)
```

# Fit the CPN Model

```{r}
fit <- cpn(y ~ x1 + x2, data = data)
```

# Summary of Results

```{r}
summary(fit)
```

# Extracting Model Components

```{r}
fit$coefficients
fit$mu
fit$sigma
fit$fitted_values[1:10]  # preview only
```

# Coefficients and Interpretation

```{r coef}
coef(fit)
coef(fit, full = FALSE)  # Includes only linear predictors
```

# Diagnostics and Residuals

```{r diagnostics}
plot(fit)
residuals(fit)[1:10]
```

# Likelihood and Information Criteria

```{r fitstats}
logLik(fit)
AIC(fit)
vcov(fit)
```

# Model Update and Comparison

```{r update-anova}
fit2 <- update(fit, . ~ . - x2)

anova(fit, fit2)  # Likelihood ratio test
anova(fit)        # Model summary
```


# Prediction

```{r predict}
# Original data
predict(fit, type = "response")[1:5]
predict(fit, type = "response", interval = "confidence")[1:5, ]

# New data
new_df <- data.frame(x1 = c("A", "A", "B", "B"), x2 = c(-0.5, -0.2, -0.3, -0.3))
predict(fit, newdata = new_df, type = "response", interval = "confidence")        
```

# Conclusion

The `cpnreg` package enables effective modeling of semicontinuous data using the
Compound Poisson-Normal model. It supports flexible model specification, S3
methods for diagnostics and inference, and prediction on new data. For more
advanced use, refer to the function documentation or the package reference
manual.

# References
